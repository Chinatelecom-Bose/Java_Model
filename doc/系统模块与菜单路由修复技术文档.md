# 系统模块集成与菜单路由修复技术文档

## 1. 后端模块集成 (Backend Integration)

### 问题描述
新创建的 `ctbc-test` 模块虽然代码逻辑完整，但访问接口时报 `404 Not Found`。

### 根本原因
虽然在根项目定义了模块，但在主启动模块 (`ctbc-admin`) 中未引入该模块的依赖，导致 Spring Boot 启动时未扫描加载该模块的 Controller 和 Service。

### 修改方案

#### 修改点 1：根项目版本管理
**文件路径**：`d:\CodeDoc\EquipmentM\pom.xml`
**修改内容**：在 `<dependencyManagement>` 中注册新模块版本。

```xml
<dependency>
    <groupId>com.ctbc</groupId>
    <artifactId>ctbc-test</artifactId>
    <version>${ctbc.version}</version>
</dependency>
```

#### 修改点 2：启动模块依赖引入
**文件路径**：`d:\CodeDoc\EquipmentM\ctbc-admin\pom.xml`
**修改内容**：在 `<dependencies>` 中加入实际依赖，确保模块被打包和加载。

```xml
<!-- 测试模块 -->
<dependency>
    <groupId>com.ctbc</groupId>
    <artifactId>ctbc-test</artifactId>
</dependency>
```

---

## 2. 前端路由逻辑适配 (Frontend Routing Logic)

### 问题描述
在“菜单管理”中直接创建一级菜单（非目录类型）时，页面无法在系统框架（侧边栏+顶部栏）内显示，或者出现白屏/404。

### 根本原因
Vue Router 需要嵌套路由结构才能实现“Layout包含页面”的效果。原代码未对一级功能菜单进行自动封装，导致其作为独立页面渲染或路径匹配失败。

### 修改方案

#### 修改点 3：路由自动封装 (Layout Auto-Wrapping)
**文件路径**：`d:\CodeDoc\EquipmentM\ctbc-ui\src\stores\permission.js`
**修改内容**：修改 `filterAsyncRouter` 和 `filterAsyncRouterForSidebar` 方法，增加对一级菜单的自动处理逻辑。

**核心代码逻辑**：
```javascript
// 修复：一级菜单且非Layout，自动转换为Layout包裹
if (!lastRouter && (!route.children || !route.children.length) && route.component && !['Layout', 'ParentView', 'InnerLink'].includes(route.component)) {
    route.children = [{
        path: 'index',
        component: route.component,
        name: route.name,
        meta: route.meta
    }];
    route.component = 'Layout';
    route.meta = null;
}
```

---

## 3. 前端交互逻辑修复 (Frontend Interaction)

### 问题描述
点击侧边栏的一级菜单时，控制台报错，菜单无响应。

### 根本原因
侧边栏组件 `SideMenu.vue` 在处理点击事件时，默认假设所有菜单都有父级路径 (`fatherPath`)。点击一级菜单时 `fatherPath` 为空，导致查找父级索引时代码出错。

### 修改方案

#### 修改点 4：菜单点击容错处理
**文件路径**：`d:\CodeDoc\EquipmentM\ctbc-ui\src\components\layout\SideMenu.vue`
**修改内容**：在 `handleMenuClick` 方法中增加对无父级菜单（一级菜单）的判断分支。

**核心代码逻辑**：
```javascript
// ...
} else if (!fatherPath) {
  // 处理一级菜单点击：不查找父级，直接定位当前菜单
  const menuIndex = props.menuData.findIndex(item => item.path === path);
  selectedKeys.value = [`no-child-${path}-${menuIndex}`];
  openKeys.value = [];
} else {
  // 原有逻辑：查找父级索引
  const fatherIndex = props.menuData.findIndex(item => item.path === fatherPath);
  // ...
}
```

---

## 4. 验证与总结
通过以上修改，系统已具备以下能力：
1.  **后端集成**：能够正确识别和加载新添加的业务模块（如 `ctbc-test`），404 错误解决。
2.  **前端展示**：能够灵活配置菜单，无论是“目录-菜单”结构还是直接的“一级菜单”，都能正常渲染并嵌入系统框架中。
3.  **交互体验**：侧边栏点击交互流畅，修复了点击一级菜单时的 JS 报错问题。
